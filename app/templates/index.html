<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ¼‚-ã—ã‚‹ã—-</title>

  <style>
    :root{
      --bg0: #f7fbff;
      --bg1: #eef6ff;
      --card: rgba(255,255,255,.20);
      --border: rgba(15, 23, 42, .10);
      --text: #0f172a;
      --muted: rgba(15, 23, 42, .60);
      --accent: #2563eb;
      --accent2:#38bdf8;
      --shadow: 0 18px 50px rgba(2, 6, 23, .10);
      --radius: 18px;

      /* ===== èƒŒæ™¯èª¿æ•´ã¤ã¾ã¿ ===== */
      --veil: 0.18;   /* èª­ã¿ã‚„ã™ã•è†œï¼ˆ0.05ã€œ0.30ï¼‰ */
    }

    *{ box-sizing: border-box; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif;
      color: var(--text);
      min-height: 100vh;
      padding: 42px 18px;
      background: #eef6ff;
      overflow-x: hidden;
    }

    /* ===== èƒŒæ™¯ï¼ˆcanvasã§ãƒ‰ãƒƒãƒˆå‹•ç”»ï¼‰ ===== */
    #bgCanvas{
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      z-index: -3;
      pointer-events: none;

      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    body::after{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -2;
      background: rgba(255,255,255,var(--veil));
      pointer-events: none;
    }

    .wrap{
      max-width: 900px;
      margin: 0 auto;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 18px;
    }

    .card h2{
      margin:0 0 12px 0;
      font-size: 16px;
      letter-spacing:.01em;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    input, textarea{
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      background: rgba(255,255,255,.85);
      outline: none;
    }
    textarea{ resize: vertical; min-height: 130px; }

    input:focus, textarea:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .btn{
      border: 1px solid rgba(37,99,235,.25);
      background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(37,99,235,.95));
      color: white;
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: 650;
      cursor: pointer;
      transition: transform .05s ease, filter .15s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:hover{ filter: brightness(1.03); }

    .btn-ghost{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.6);
      color: var(--text);
    }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }

    .bottle{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px dashed rgba(15, 23, 42, .20);
      background: rgba(255,255,255,.60);
      padding: 14px;
      position: relative;
      overflow: hidden;
    }
    .bottle::before{
      content:"";
      position:absolute;
      inset:-40px -40px auto auto;
      width:160px; height:160px;
      background: radial-gradient(circle at 30% 30%, rgba(56,189,248,.35), transparent 55%);
      transform: rotate(12deg);
    }
    .bottle pre{
      margin: 0;
      white-space: pre-wrap;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif;
      font-size: 14px;
      line-height: 1.7;
      position: relative;
    }

    /* ===== Splash / Boot animation ===== */
    body.is-booting #app{
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
    }

    #splash{
      position: fixed;
      inset: 0;
      z-index: 10;
      display: grid;
      place-items: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 3000ms ease;
    }

    body.is-booting #splash{ opacity: 1; }
    body.is-ready #splash{ opacity: 0; }

    body.is-ready #app{
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
      transition: opacity 900ms ease, transform 900ms ease;
    }

    .pixel-title{
      font-size: clamp(72px, 10vw, 140px);
      letter-spacing: .12em;
      color: rgba(255,255,255,.92);
      text-shadow:
        0 2px 0 rgba(0,0,0,.30),
        0 16px 60px rgba(0,0,0,.35);
      filter:
        drop-shadow(6px 0 0 rgba(0,0,0,.22))
        drop-shadow(-6px 0 0 rgba(0,0,0,.22))
        drop-shadow(0 6px 0 rgba(0,0,0,.22))
        drop-shadow(0 -6px 0 rgba(0,0,0,.22));
    }

    .scene{
      display:none;
      opacity:0;
      transform: translateY(8px);
      transition: opacity 500ms ease, transform 500ms ease;
    }
    .scene.is-active{
      display:block;
      opacity:1;
      transform: translateY(0);
    }

    .card.center{
      max-width: 520px;
      margin: 0 auto;
    }
    .card.center.ghost{
      background: rgba(255,255,255,.12);
    }

    .grid.choice{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media (min-width: 860px){
      .grid.choice{ grid-template-columns: 1fr 1fr; }
    }

    .choice-btn{
      text-align:left;
      cursor:pointer;
      transition: transform .08s ease, filter .15s ease;
    }
    .choice-btn:hover{ filter: brightness(1.03); }
    .choice-btn:active{ transform: translateY(1px); }

    .choice-icon{ font-size: 40px; margin-bottom: 10px; }

    .walk-text{
      font-size: clamp(28px, 4vw, 44px);
      letter-spacing: .08em;
      color: rgba(255,255,255,.92);
      text-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    .walk-sub{ margin-top: 10px; color: rgba(255,255,255,.75); }
  </style>
</head>

{% set has_anon = request.cookies.get("anon_id") %}
<body data-has-anon="{% if has_anon %}1{% else %}0{% endif %}">

  <canvas id="bgCanvas"></canvas>

  <video id="bgVideo" muted loop playsinline preload="auto" style="display:none">
    <source src="/static/ocean.mp4" type="video/mp4" />
  </video>

  <div id="splash" aria-hidden="true">
    <div class="pixel-title">æ¼‚-ã—ã‚‹ã—-</div>
  </div>

  <div class="wrap" id="app">
    <!-- Scene: nicknameï¼ˆanonãŒç„¡ã„æ™‚ã ã‘æœ€åˆã«å‡ºã™ï¼‰ -->
    <section id="scene-nick" class="scene {% if not has_anon %}is-active{% endif %}">
      <div class="card center">
        <h2>æ¼‚-ã—ã‚‹ã—-</h2>
        <p class="sub">ã¾ãšã€ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ•™ãˆã¦ã€‚</p>

        <form id="nickForm" action="/anon" method="post">
          <input id="nickInput" name="nickname" maxlength="32" placeholder="ã›ã®ã‚" required />
          <div class="row" style="margin-top:12px;">
            <button class="btn" type="submit">æµ·ã«å…¥ã‚‹</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Scene: walking -->
    <section id="scene-walk" class="scene">
      <div class="card center ghost">
        <div class="walk-text">ç ‚æµœã‚’æ­©ãâ€¦â€¦</div>
        <div class="walk-sub">ã–ãã€ã–ãã€ã–ãã€‚</div>
      </div>
    </section>

    <!-- Scene: choiceï¼ˆanonãŒã‚ã‚‹æ™‚ã¯æœ€åˆã“ã“ã‹ã‚‰ï¼‰ -->
    <section id="scene-choice" class="scene {% if has_anon %}is-active{% endif %}">
      <div class="grid choice">
        <button class="card choice-btn" id="chooseBottle" type="button">
          <div class="choice-icon">ğŸ¾</div>
          <h2>æ¼‚æµãƒœãƒˆãƒ«</h2>
          <p class="hint">ä»Šæ—¥å±Šã„ãŸç“¶ã®æ‰‹ç´™ã‚’ã²ã¨ã¤èª­ã‚€</p>
        </button>

        <button class="card choice-btn" id="choosePen" type="button">
          <div class="choice-icon">ğŸ“</div>
          <h2>ç´™ã¨ãƒšãƒ³</h2>
          <p class="hint">æµ·ã«æµã™è¨€è‘‰ã‚’æ›¸ã</p>
        </button>
      </div>
    </section>

    <!-- Scene: read bottle -->
    <section id="scene-read" class="scene">
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <h2>ä»Šæ—¥ã®ãƒœãƒˆãƒ«</h2>
            <div class="hint">â€»1æ—¥1é€š / ä»Šæ—¥ã®1å›ã ã‘</div>
          </div>
          <button class="btn btn-ghost" id="backFromRead" type="button">æˆ»ã‚‹</button>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn" id="btnLoadToday" type="button">å—ã‘å–ã‚‹</button>
        </div>

        <div class="bottle">
          <pre id="today">ã¾ã å—ã‘å–ã£ã¦ã„ãªã„ã€‚</pre>
        </div>
      </div>
    </section>

    <!-- Scene: write bottle -->
    <section id="scene-write" class="scene">
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <h2>ãƒœãƒˆãƒ«ã‚’æµã™</h2>
            <div class="hint">â€»1æ—¥3æœ¬ã¾ã§ï¼ˆMVPï¼‰</div>
          </div>
          <button class="btn btn-ghost" id="backFromWrite" type="button">æˆ»ã‚‹</button>
        </div>

        <form action="/bottles" method="post" style="margin-top:12px;">
          <label>ã“ã¨ã°</label>
          <textarea name="content" maxlength="2000" placeholder="ä»Šæ—¥ã€æµ·ã«æµã—ãŸã„ã²ã¨ã“ã¨ã€‚"></textarea>
          <div class="row" style="margin-top:12px;">
            <button class="btn" type="submit">æµã™</button>
          </div>
        </form>
      </div>
    </section>
  </div>

  <script>
    const HAS_ANON = document.body.dataset.hasAnon === "1";

    async function loadToday() {
      const el = document.getElementById("today");
      el.textContent = "â€¦â€¦æ¼‚æµä¸­";
      const res = await fetch("/today", { credentials: "same-origin"});

      if (res.status === 401) {
        show("scene-nick");
        return;
      }

      if (!res.ok) {
        el.textContent = "ã†ã¾ãå—ã‘å–ã‚Œãªã‹ã£ãŸã€‚ã‚‚ã†ä¸€åº¦ãŸã‚ã—ã¦ã€‚"
        return;
      }

      const data = await res.json();
      if (data.bottle && data.bottle.content) {
        el.textContent = data.bottle.content + "\n\n" + "( bottle_id: " + data.bottle.id + " )";
      } else {
        el.textContent = data.message || "ä»Šæ—¥ã¯ã¾ã å±Šã‹ãªã„ã€‚";
      }
    }

    // ===== Pixelated video background (Canvas) =====
    (() => {
      const video = document.getElementById("bgVideo");
      const canvas = document.getElementById("bgCanvas");
      const ctx = canvas.getContext("2d", { alpha: false });

      // -------- tuning knobs --------
      const PIXEL = 2;     // ãƒ‰ãƒƒãƒˆç²—ã•
      const PLAYBACK = 0.7;
      const SAT = 1;
      const CON = 1;
      // -----------------------------

      const off = document.createElement("canvas");
      const offCtx = off.getContext("2d", { alpha: false });

      function resize() {
        const dpr = Math.max(1, window.devicePixelRatio || 1);

        // è¦‹ãŸç›®ã‚µã‚¤ã‚º
        const cssW = window.innerWidth;
        const cssH = window.innerHeight;

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å®Ÿãƒ”ã‚¯ã‚»ãƒ«ï¼ˆdprè¾¼ã¿ï¼‰
        canvas.width = Math.floor(cssW * dpr);
        canvas.height = Math.floor(cssH * dpr);

        // CSSã§ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’æ˜ç¤ºï¼ˆã‚ºãƒ¬é˜²æ­¢ï¼‰
        canvas.style.width = cssW + "px";
        canvas.style.height = cssH + "px";

        // ctxåº§æ¨™ç³»ã‚’CSSãƒ”ã‚¯ã‚»ãƒ«ã«æˆ»ã™
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        // ãƒ”ã‚¯ã‚»ãƒ«åŒ–ç”¨ã®ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆCSSãƒ”ã‚¯ã‚»ãƒ«åŸºæº–ã§OKï¼‰
        off.width = Math.max(1, Math.floor(cssW / PIXEL));
        off.height = Math.max(1, Math.floor(cssH / PIXEL));

        offCtx.imageSmoothingEnabled = false;
        ctx.imageSmoothingEnabled = false;
      }

      function draw() {
        if (video.readyState >= 2 && video.videoWidth && video.videoHeight) {
          const vw = video.videoWidth;
          const vh = video.videoHeight;

          const targetW = off.width;
          const targetH = off.height;

          const videoAspect = vw / vh;
          const targetAspect = targetW / targetH;

          let sx = 0, sy = 0, sw = vw, sh = vh;

          // coverï¼šæ¯”ç‡ç¶­æŒã§ã€Œç”»é¢ã‚’åŸ‹ã‚ã‚‹ã€
          if (videoAspect > targetAspect) {
            // æ¨ªé•· â†’ å·¦å³ã‚’åˆ‡ã‚‹
            sh = vh;
            sw = Math.round(vh * targetAspect);
            sx = Math.round((vw - sw) / 2);
            sy = 0;
          } else {
            // ç¸¦é•· â†’ ä¸Šä¸‹ã‚’åˆ‡ã‚‹
            sw = vw;
            sh = Math.round(vw / targetAspect);
            sx = 0;
            sy = Math.round((vh - sh) / 2);
          }

          // â‘  ç¸®å°ã—ã¦ãƒ‰ãƒƒãƒˆåŒ–
          offCtx.drawImage(video, sx, sy, sw, sh, 0, 0, targetW, targetH);

          // â‘¡ æ‹¡å¤§ã—ã¦èƒŒæ™¯ã¸ï¼ˆCSSãƒ”ã‚¯ã‚»ãƒ«ã«æãï¼‰
          ctx.filter = `saturate(${SAT}) contrast(${CON})`;
          ctx.drawImage(off, 0, 0, targetW, targetH, 0, 0, window.innerWidth, window.innerHeight);
          ctx.filter = "none";
        }
        requestAnimationFrame(draw);
      }

      resize();
      window.addEventListener("resize", resize, { passive: true });

      video.playbackRate = PLAYBACK;
      video.addEventListener("canplay", () => {
        video.playbackRate = PLAYBACK;
        video.play().catch(() => {});
      });

      const p = video.play();
      if (p && typeof p.catch === "function") p.catch(() => {});

      requestAnimationFrame(draw);
    })();

    // ===== Scene control =====
    function show(id){
      document.querySelectorAll(".scene")
        .forEach(s => s.classList.remove("is-active"));
      const el = document.getElementById(id);
      if (el) el.classList.add("is-active");
    }

    // ===== Boot animation (title -> UI) =====
    (() => {
      document.body.classList.add("is-booting");

      const SHOW_MS = 1200;
      const FADE_MS = 900;

      const start = () => {
        setTimeout(() => {
          document.body.classList.remove("is-booting");
          document.body.classList.add("is-ready");

          // â˜…Bootå¾Œã«åˆæœŸã‚·ãƒ¼ãƒ³ã‚’ç¢ºå®šï¼ˆã“ã“ãŒã‚ºãƒ¬é˜²æ­¢ï¼‰
          show(HAS_ANON ? "scene-choice" : "scene-nick");
        }, SHOW_MS);

        setTimeout(() => {
          const s = document.getElementById("splash");
          if (s) s.remove();
        }, SHOW_MS + FADE_MS + 150);
      };

      const v = document.getElementById("bgVideo");
      if (v && v.readyState >= 2) {
        start();
      } else if (v) {
        v.addEventListener("canplay", start, { once: true });
        setTimeout(start, 1800);
      } else {
        setTimeout(start, 800);
      }
    })();

    // ===== Buttons wiring =====
    (() => {
      const chooseBottle = document.getElementById("chooseBottle");
      const choosePen = document.getElementById("choosePen");
      const backFromRead = document.getElementById("backFromRead");
      const backFromWrite = document.getElementById("backFromWrite");
      const btnLoadToday = document.getElementById("btnLoadToday");

      chooseBottle?.addEventListener("click", () => show("scene-read"));
      choosePen?.addEventListener("click", () => show("scene-write"));

      backFromRead?.addEventListener("click", () => show("scene-choice"));
      backFromWrite?.addEventListener("click", () => show("scene-choice"));

      btnLoadToday?.addEventListener("click", loadToday);
    })();
  </script>
</body>
</html>